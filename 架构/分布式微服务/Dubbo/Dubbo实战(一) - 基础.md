# 1 背景

随着互联网的发展，网站应用的规模不断扩大，常规的垂直应用架构已无法应对，分布式服务架构以及流动计算架构势在必行，亟需一个治理系统确保架构有条不紊的演进。

![](https://ask.qcloudimg.com/http-save/1752328/xa7y4nsfud.png)

## 1.1 单一应用架构

当网站流量很小时，只需一个应用，将所有功能都部署在一起，以减少部署节点和成本。

此时，用于简化增删改查工作量的数据访问框架(ORM)是关键。

## 1.2 垂直应用架构

当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架(MVC)是关键。

## 1.3 分布式服务架构

当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。

此时，用于提高业务复用及整合的分布式服务框架(RPC)是关键。

## 1.4 流动计算架构

当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。

此时，用于提高机器利用率的资源调度和治理中心(SOA)是关键。

# 2 需求

![](https://ask.qcloudimg.com/http-save/1752328/tb9hskdpgc.png)

在大规模服务化之前，应用可能只是通过 RMI 或 Hessian 等工具，简单的暴露和引用远程服务，通过配置服务的URL地址进行调用，通过 F5 等硬件进行负载均衡。

> **Java远程方法调用**，即**Java RMI**（Java Remote Method Invocation）是Java里一种用于实现**远程过程调用**的**应用程序编程接口**。它使客户机上运行的程序可以调用远程服务器上的对象。远程方法调用特性使Java编程人员能够在网络环境中分布操作
> RMI全部的宗旨就是尽可能简化远程接口对象的使用。
> Java RMI极大地依赖于接口。在需要创建一个远程对象的时候，程序员通过传递一个接口来隐藏底层的实现细节。客户端得到的远程对象句柄正好与本地的根代码连接，由后者负责透过网络通信。这样一来，程序员只需关心如何通过自己的接口句柄发送消息。

所使用Java包的名字是java.rmi。

> Hessian是一个轻量级的remoting onhttp工具，使用简单的方法提供了RMI的功能。 相比WebService，Hessian更简单、快捷。采用的是二进制RPC协议，因为采用的是二进制协议，所以它很适合于发送二进制数据。
> F5设备用于最大限度提升链路性能与可用性的下一代广域网链路流量管理。

**当服务越来越多时，服务 URL 配置管理变得非常困难，F5 硬件负载均衡器的单点压力也越来越大** 

此时需要一个服务注册中心，动态地注册和发现服务，使服务的位置透明

并通过在消费方获取服务提供方地址列表，实现软负载均衡和 Failover，降低对 F5 硬件负载均衡器的依赖，也能减少部分成本。

**当进一步发展，服务间依赖关系变得错踪复杂，甚至分不清哪个应用要在哪个应用之前启动，架构师都不能完整的描述应用的架构关系**

这时，需要自动画出应用间的依赖关系图，以帮助架构师理清理关系。

**接着，服务的调用量越来越大，服务的容量问题就暴露出来，这个服务需要多少机器支撑？什么时候该加机器？** 

为了解决这些问题

- 第一步，要将服务现在每天的调用量，响应时间，都统计出来，作为容量规划的参考指标
- 其次，要可以动态调整权重，在线上，将某台机器的权重一直加大，并在加大的过程中记录响应时间的变化，直到响应时间到达阈值，记录此时的访问量，再以此访问量乘以机器数反推总容量

# 3 架构

## 3.0 dubbo-architucture

![](https://ask.qcloudimg.com/http-save/1752328/snkfo3jtpz.png)

## 3.1 节点角色说明

| 节点 | 角色说明 |
|:----|:----|
| Provider | 暴露服务的服务提供方 |
| Consumer | 调用远程服务的服务消费方 |
| Registry | 服务注册与发现的注册中心 |
| Monitor | 统计服务的调用次数和调用时间的监控中心 |
| Container | 服务运行容器 |


## 3.2 调用关系说明

1. Container负责启动，加载，运行Provider
2. Provider在启动时，向Registry注册自己提供的服务
3. Consumer在启动时，向Registry订阅自己所需的服务
4. Registry返回Provider地址列表给Consumer，如果有变更，Registry将基于长连接推送变更数据给Consumer。
5. Consumer从Provider地址列表中，基于软负载均衡算法，选一台Provider调用，如果调用失败，再选另一台
6. 服务Consumer和Provider，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心

## 3.3 Dubbo 的架构特点

### 3.3.1 连通性

- 注册中心负责服务地址的注册与查找
相当于目录服务，服务提供者和消费者只在**启动时与注册中心交互**，注册中心不转发请求，压力较小
- 监控中心负责统计各服务调用次数，调用时间等
统计先在内存汇总,每分钟一次发送到监控中心服务器，并以报表展示
- 服务提供者向注册中心注册其提供的服务
并汇报调用时间到监控中心，此时间`不包含网络开销`
- 服务消费者向注册中心获取服务提供者地址列表
并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包`含网络开销`
- 注册中心，服务提供者，服务消费者三者之间均为`长连接`，监控中心除外
- 注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者
- 注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，`消费者在本地缓存了提供者列表`
- `注册中心和监控中心都是可选`，服务消费者可以直连服务提供者

### 3.3.2 健壮性

- 监控中心宕掉不影响使用，只是**丢失部分采样数据**
- DB宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务
- 注册中心对等集群，任意一台宕掉后，将自动切换到另一台
- 注册中心全宕，服务提供者和服务消费者仍能通过本地缓存通讯
- 服务提供者无状态，任意一台宕掉，不影响使用
- 服务提供者全宕，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复

### 3.3.3 伸缩性

- 注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心
- 服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者

### 3.3.4 升级性

当服务集群规模进一步扩大，带动IT治理结构进一步升级，需要实现动态部署，进行流动计算，现有分布式服务架构不会带来阻力。

#### 3.3.4.0 未来可能的一种架构图

- dubbo-architucture-futures
![](https://ask.qcloudimg.com/http-save/1752328/yfisvqssc8.png)

#### 3.3.4.1 节点角色说明

| 节点 | 角色说明 |
|:----|:----|
| Deployer | 自动部署服务的本地代理 |
| Repository | 仓库用于存储服务应用发布包 |
| Scheduler | 调度中心基于访问压力自动增减服务提供者 |
| Admin | 统一管理控制台 |
| Registry | 服务注册与发现的注册中心 |
| Monitor | 统计服务的调用次数和调用时间的监控中心 |


# 4 用法

## 4.1 本地服务 Spring 配置

- local.xml
![](https://ask.qcloudimg.com/http-save/1752328/go8vywd4fo.png)

## 4.2 远程服务 Spring 配置

在本地服务的基础上，只需做简单配置，即可完成远程化：

- 将上面的 _**local.xml**_ 配置拆分成两份，将服务定义部分放在服务提供方 _**remote-provider.xml**_，将服务引用部分放在服务消费方 _**remote-consumer.xml**_
- 并在提供方增加暴露服务配置  _**<dubbo:service>**_ ，在消费方增加引用服务配置 _**<dubbo:reference>**_
- remote-provider.xml
![](https://ask.qcloudimg.com/http-save/1752328/c81suggl05.png)
- remote-consumer.xml
![](https://ask.qcloudimg.com/http-save/1752328/1dsi93kzug.png)

# 参考
- [用户文档 - 入门](https://dubbo.apache.org/zh-cn/docs/user/preface/)
- [Java远程方法调用](https://zh.m.wikipedia.org/wiki/Java%25E8%25BF%259C%25E7%25A8%258B%25E6%2596%25B9%25E6%25B3%2595%25E8%25B0%2583%25E7%2594%25A8)
- [Hessian](https://baike.baidu.com/item/Hessian)
- [F5设备](https://baike.baidu.com/item/F5%25E8%25AE%25BE%25E5%25A4%2587)