# 09-DDD在大厂交易系统演进的应用

结合DDD介绍交易系统演进过程。

## 1 交易业务-整体介绍

主要涉及三类交易业务场景：

- 境外出行
- 商场团购
- 内容商业化

境外城市站有美食、购物、商场、景点、门票、当地玩乐等频道入口，可购买境外出行交易产品，在境内的逛街/商场频道可以找到商场团购优惠以及商场团购代金券。

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/86f7dccc87e4bb9eb42a996f0ff3670b.png)

商家如有推广需求，可在商家端App（开店宝App）“点星”入口购买达人的创作服务，最终达人交付的笔记，在点评App信息流里进行展示。

- 境外出行产品覆盖景点门票、餐厅订座和休闲娱乐
- 商场团购产品包含普通团单和秒杀团单，适用于商场的优惠活动
- 内容商业化产品则允许商家购买达人的图文或视频笔记，以此来推广自己的服务或产品

## 2 DDD概述

### 2.1 啥是DDD

一种软件设计方法，主要用于处理复杂业务需求。可将其分解为：

- 领域，特定的业务范围或问题域，如电商、医疗、保险等。确定领域后，我们就能明确核心的业务问题。例如，在电商中，核心问题可能涉及商品、库存、仓储和物流；在保险领域，则可能关注投保、承保和理赔等方面
- 设计，在DDD中通常指的是领域模型的设计，DDD强调领域模型是系统的核心，它反映了业务概念和业务规则
- 驱动，两层含义：
  - 业务问题域驱动领域建模的过程
  - 领域模型驱动技术实现或代码开发的过程。确保领域模型的准确性是关键，因为它可以保证代码实现能够真实反映并解决业务的核心问题

一种处理高度复杂领域的设计思想，通过分离技术实现的复杂性，围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解、难以演化等问题。

首先体现分离思想，分离业务复杂性和技术复杂性，其次体现分治思想，它通过领域模型、限界上下文或子域进行分治。

### 2.2 DDD核心概念

- “统一语言”，贯穿DDD从战略设计到战术设计到最后的代码实现全过程，对需求分析、知识提炼和最后代码的实现都重要
- “限界上下文”，连接问题空间和解决方案空间的桥梁：
  - 在问题空间分析问题时，它是语言的边界和模型的边界
  - 在解决方案空间我们通过限界上下文来确定应用的边界和技术的边界，从而帮助我们确定整个系统及各个限界上下文的解决方案

### 2.3 DDD的过程

首先，领域驱动设计需要业务、产品、研发以及QA共同参与，应基于对问题域及业务愿景的理解，并进行充分讨论而达成统一认知，在这过程中提炼领域知识，并建立统一语言。

同时在领域知识基础进一步提炼，分解问题域为核心子域、支撑子域和通用子域，再通过模型驱动设计思想，设计领域模型，通过领域模型连接业务和系统，并且在模型驱动设计过程中，会有新的认知迭代。通过这些认知迭代进一步丰富统一语言，因此领域知识是一个不断迭代、螺旋式推进的过程。

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/3a1193880ada6eec70f327f313dcafa3.png)

## 3 交易系统演进

从业务视角和技术视角，分别有三阶段。

### 3.1 业务视角

- 单业务线单业务形态阶段，只支持境外出行交易业务场景，包含预订的业务形态
- 单业务线多业务形态阶段，业务形态更丰富
- 多业务线多业务形态阶段

### 3.2 技术视角

简单架构、微服务架构和平台化架构。

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/d9969f9d77b779bc48b24710f81cf69f.png)

#### 3.2.1 简单架构阶段

业务和系统起步阶段，只支持预订形态的一两个品类交易，整体简单，团队规模也小，为快速支持业务上从0到1不断试错，在技术系统建设的主要思路按业务环节对业务功能模块做简单划分，从而做到快速迭代和交付。

##### 系统架构

简单，根据业务进行基础拆分：

- 接入层分为商家B端、商品C端和订单C端
- 服务层则划分为商家、商品和订单三个部分
- 整体采用MVC分层架构。这种架构在项目初期确实展现优势，即“简单”和“快”

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/3240b93d9af9d7408c0c8c4799bb1421.png)

但随业务需求不断增加和复杂，系统

##### 暴露问题

- 数据驱动设计，先建立数据库表，导致模型无法直观反映业务实际情况
- 传统分层架构，将数据库表映射为持久化对象（PO），然后在服务层通过CRUD操作进行过程式编程。这在多个场景下出现了功能相似但又有所不同的需求时，经常导致重复编写相似的代码，最终造成逻辑分散，系统整体内聚性不足

以订单退款逻辑为例，面临订单确认前/后退款、履约前/后退款等多种场景，及需要考虑由用户（买家）、商家（卖家）、客服和系统等不同角色发起的退款。虽然这些不同场景和角色发起的退款业务逻辑在很大程度上是相似的，但它们之间也存在一些差异。

传统MVC缺乏对业务领域的深入理解和沉淀，服务间调用缺乏清晰结构，导致逻辑交织。研发团队在系统迭代过程中可能没有足够重视高内聚和低耦合的设计原则。因此，系统内部往往会出现多处重复且相似的订单退款代码逻辑：

- 降低可读性
- 系统可维护性带来挑战

#### 3.2.2 微服务化阶段

随业务品类增加和业务模式多样化，业务和系统复杂度迅速上升，团队规模也相应扩大。这种复杂性主要由三个因素造成：

- 业务规模扩张带来系统规模和代码量增加
- 业务需求的累积导致了系统内部的重复代码、复杂的依赖关系，以及为了满足高可用性和高性能需求而引入的各种技术组件和并行、异步解决方案
- 业务需求的频繁变动也增加了系统的复杂性

为应对这些挑战，通过分治管理软件规模，利用系统分层和关注点分离的原则来优化系统结构，及通过隔离变化来应对频繁的需求迭代。这些策略都是DDD核心理念，基此，实施了微服务架构的拆分，以更好地管理和控制系统复杂性。

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/af540eba5fdb0e30fec641d2ecc14642.png)

##### DDD落地方法

参照行业实践内容并且结合自身理解，将DDD实施过程划分四阶段：

1. **理解问题域**：深入分析业务价值、需求以及构建业务概念模型。产出统一语言和子域划分，确保团队在业务理解达共识
2. **识别限界上下文**：通过组织、业务和应用的边界来确定限界上下文，并且明确不同上下文间的关系和交互
3. **领域建模**：包括领域分析、设计建模，以及模型的持续迭代。目标是构建能够反映业务核心概念和规则的模型
4. **模型实现**：主要依赖应用分层架构、微服务架构和应用集成，确保领域模型能够在系统中得到有效实施

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/c4daef7a41b5cfaf5fe427ed55f944ea.png)

##### ① 理解问题域

业务价值分析有助于评估系统的复杂性，并且可以指导我们识别最为关键的业务领域。业务需求分析是一个关键的知识提炼过程，其中涉及多种方法和工具，例如事件风暴、四色建模以及用例分析等，我们采用的是相对轻量的用例分析法。

##### ② 问题域分析-业务需求分析

用例分析前，先要对业务流程细致分析。通过拆解业务流程和环节，帮助发现和识别具体业务用例。这里简化交易业务流程的分析。对不熟悉的业务领域，需进行更深入业务流程和场景分析。

交易业务流程分四部分：

- 客户合作流程
- 商家上单流程
- 在线交易流程
- 资金结算流程

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/c27b4b3c677ac7c22e5680786941898d.png)

有了这些流程分解，就可进入具体用例分析阶段。

用例分析阶段，以商家上单流程和在线交易流程为例说明。商家上单流程，涉及主要角色包括商家和运营：

- 商家负责创建新商品、商品上架、商品下架以及更新商品库存等操作
- 运营人员则参与商品审核，包括审核通过、审核驳回、查看审核列表等关键用例

在线交易流程，参与方主要是买家、商家以及客服。买家行为包括购买商品、支付、申请退款和查看订单等，商家则处理订单确认、发送凭证、核销凭证和订单检索等关键用例。客服则参与售后服务，涉及订单退款、订单赔付等核心用例。

完成业务流程和用例分析后，可根据相关性对问题进行初步分类，并划分不同子域，建立统一语言。为更好地进行知识提炼，为识别限界上下文和建立领域模型提供必要的信息，我们需要深入分析每个用例，并制定用例规约来提取关键概念。

实际操作没有严格制定用例规约，而是使用产品需求文档中的描述。在技术方案设计阶段，我们也会使用类似于时序图和接口描述的方法来详细阐述用例。无论采用哪种描述方式，关键在于坚持使用统一语言，这对于从描述中提炼出核心概念至关重要。这样做不仅有助于团队成员之间的沟通，也便于后续的设计和开发工作。

在业务流程分析、用例分析以及用例规约的制定和编写之后，我们对交易业务的领域知识已经有了充分的了解，并构建了相应的概念模型。在这个模型中，销售签约商家，商家负责商品的创建，用户选择商品进行下单，下单购买过程中可能会使用优惠，在订单完成之后需要财务介入对商家进行结算。

关键概念归类后，识别出商家、商品、订单、优惠和结算等子域。已熟悉的领域，是否真需经过这样复杂分析和提炼过程来划分子域？对有经验架构师，确实可迅速地完成子域识别和划分，这也展示DDD过程一种艺术性。然而，这些系统性分析步骤确保即使不熟悉领域的团队成员，也能准确理解业务并作出恰当架构决策。

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/6b71260413bb8d7aed3eb71e2e86c576.png)

在问题域分析阶段主要的输出包括：

- 统一语言，通过用例分析，提炼商家、买家、商品等统一语言，通过用例规约的整理对统一语言进行丰富，包括售卖规则、售卖单元、订单项等，可用这些统一语言进行交流并用于后面的模型设计和代码实现
- 子域划分，最终识别出如图几个子域，结合价值分析阶段得到的为用户提供一站式服务体验，以及为商家提供一体化售卖平台的这样的核心价值，将商品域、订单域作为核心域重点建设

子域划分方法，可分别按业务和组织两个视角。业务视角可按业务环节或业务方向划分，即按业务环节来划分，将商家合作到商品上单再到交易和结算的整个业务流程进行阶段划分，按划分出来的每个环节确定子领域。

当目标系统为客户提供多个业务方向的产品时，可根据业务方向进行子领域划分，如银行系统可从储蓄、理财、外汇等几个方向进行拆分；当目标系统用于企业的管理时，可以从组织视角按照业务职能部门进行划分。

微服务化阶段-问题域分析-问题子域划分：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/55dbaea4527ac98da9757b0b325d1d21.png)

**识别限界上下文**

对问题域进行充分分析后，进入限界上下文识别阶段。连接问题空间与解决方案空间的重要桥梁;

- 在问题空间分析问题时，它是语言的边界和模型的边界，也就是业务边界
- 在解决方案空间，通过限界上下文确定应用的边界

所以我们在限界上下文识别时，也主要从业务边界和应用边界两方面进行。首先基于语义相关性和功能相关性，对我们在问题域分析阶段所罗列的业务活动进行归类，优先考虑功能相关性，得到初步的限界上下文划分，在交易系统分析过程中，这个结果与子域划分结果基本一致。

微服务化阶段-识别限界上下文-业务边界：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/6348fcbf2d2068e33103c2bf41265634.png)

- 语义相关性主要针对业务活动的名词，具有相同宾语的业务活动可以归类到同一个业务主体
- 功能相关性从业务活动所服务的业务目标进行归类，同一业务目标相关的业务活动可以归为一类

限界上下文具体要到啥粒度？和我们的业务复杂度、技术复杂度及团队规模有一定关系，结合实际，对商品和订单这两个核心域的限界上下文做进一步的识别和划分。

仔细思考后我们发现，尽管商品和订单是贯穿整个业务流程的核心概念，但在业务流程的不同阶段涉及不同的参与方和关注点，对应到系统能力上的诉求也不尽相同。

#### 以商品为例

涉及商品创建、审核发布及用户端的展示销售：

- 商品创建阶段，商家关注录单效率和商品制作过程的管理
- 审核阶段，运营关注审核需求和审核效率
- 展示销售阶段，用户关注商品信息、价格库存以及如何做出购买决策

订单类似，在购买、履约和售后各阶段，关注点也不同。因此，对商品和订单限界上下文细分，以确保系统设计能够更精准地满足各阶段的业务需求。

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/192d10bd017592011f8c01e9a149b2d0.png)

限界上下文的识别过程虽本质仍是对问题域拆分和求解的过程，但同时限界上下文也是应用的边界和技术的边界，所以也要考虑一些质量需求和技术因素，注意仍要遵循先业务后技术原则，且考虑技术因素时，仍要保证领域模型的完整性和一致性。

从质量属性、服务集成和功能复用三方面对限界上下文做进一步划分，以商品计算为例，商品计算量大、任务多、规则复杂，为避免影响正常的商品展示和售卖，所以从展销上下文进行拆解。商品和订单都涉及要与很多第三方系统对接，将第三方服务的集成划分为单独的直连上下文，隔离三方系统差异对内部商品和订单相关系统带来的变化。

功能复用，考虑对多个限界上下文都涉及的功能提炼，作为单独的上下文，如商家权限上下文。

微服务化阶段-识别限界上下文-应用边界：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/2871504c75bcf6bad378203ed6d2a49d.png)

限界上下文封装了按照纵向切分的业务能力，那多个限界上下文如何协作来完成一个完整的业务场景呢，这就涉及到限界上下文的映射，按照通信集成模式和团队协作模式来划分，有多种映射关系，这里面我们用到最多的是通过防腐层、开放主机服务和发布语言三者联动来隔离上下游的变化、维护整个领域模型的稳定性。

微服务化阶段-识别限界上下文-总结：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/deb99f49307dde58438921509f9fd967.png)

上下文识别：

- 组织边界
- 业务边界
- 应用边界

验证原则：

- 正交原则
- 奥卡姆剃刀原则

通信集成模式：

- 防腐层
- 开放主机服务
- 发布语言
- 共享内核

团队协作模式：

- 合作者
- 客户方/供应方
- 分离模式
- 遵奉者

**领域建模**

在领域建模阶段，我们整体上分为领域分析建模和领域设计建模。首先，主要是对用例以及用例规约和用户故事进行详细的分析，从中通过名词法和动词法寻找领域概念来构建我们的领域分析模型。在此基础上，我们基于DDD战术设计的元模型，识别出这些概念中的实体和值对象，并且根据业务规则的不变性设计聚合。

以订单为例，这里是我们简化之后的模型，包括订单、支付单、履约单、凭证以及退款单这样几个聚合，在存在状态变化时，聚合之间通过领域事件进行协作。

微服务化阶段-领域建模-建模过程和方法：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/b3269e5ab420139bf5e5a261162ab6c7.png)

领域分析建模：

- 分析用例规约和用户故事
- 寻找概念对象，名词和动词
- 识别语义联系，添加关联关系

领域设计建模：

- 区分实体和值对象，丰富领域行为
- 定义聚合、识别聚合根
- 添加领域服务和领域事件

**模型实现**

在完成限界上下文的识别以及领域模型的设计之后，接下来进入到代码实现阶段，那我们如何将具体的业务流程或业务活动映射到我们的系统进行代码实现呢。这里我们首先是从业务视角对业务流程和业务活动进行分层结构化拆解，其实我们之前的用例分析和用例规约就是这个拆解过程，在拆解之后，我们按照一定的映射关系将其映射到用户接口、应用服务、领域服务、聚合和端口的实现上。

微服务化阶段-模型实现-领域模型映射：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/d18b23845bdbc0bfd49693b001223911.png)

最后，按限界上下文划分微服务，服务内部按照分层架构实现。整体上基于关注点分离和SOLID原则，分为接入层、应用层、领域层和基础设施层。最终需维护领域层的稳定性：

- 对上由接入层和应用层来隔离变化
- 对下由基础设施层通过依赖倒置的方式，隔离数据及外部依赖的差异性和变化

微服务化阶段-模型实现-应用分层架构：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/55544eb2ac9d10759eb85c6ddf3360b3.png)

分层架构原则：关注点分离+SOLID原则

分层架构实践
接入层：

- 负责向用户显示信息和解释用户指令
- 安全认证、权限校验、限流控制

应用层

- 面向用例和流程，不包含业务规则和逻辑
- 服务组合和编排

领域层

- 关注核心业务逻辑实现
- 表达业务概念、业务状态、业务规则

基础设施层

- 提供通用技术和基础服务
- 依赖倒置设计(DIP原则)

### 3.3 平台化阶段

出现商场团购、内容商业化等交易场景，技术上可通过平台化思路将底层系统能力进行复用，提升各业务支持效率。同时，DDD战略模式也重点关注组织上如何更好的管理大型业务系统，因此我们可以结合DDD来构建平台领域模型和业务扩展模型，从而更高效完成平台化改造。

主要以业务最为复杂的境外交易业务作为基础的主领域模型，并按DDD领域建模过程对商场团购和商业化业务进行拆解得到的领域模型与主领域模型进行映射匹配，经过同类项识别、归并和重组，得到平台领域模型和各业务的扩展模型。

实际落地，为实现在多业务之间进行最大化复用目标，在平台领域模型的构建上做进一步提炼，将平台领域模型拆解为基础领域模型，以及预订业务模型、团购业务模型等按照业务形态划分的领域模型。

平台化阶段-平台领域模型提炼：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/6eee6efcac8a7853e34ba30550e36c2f.png)

为提升业务BP和平台团队的协作效率，在平台领域模型和业务领域模型划分的基础上，我们采用了基于插件化的集成开发模式。通过扩展点的定义，由各业务线在各自的插件包里基于业务扩展模型进行业务定制化实现，再集成平台领域模型和业务扩展模型，最后实现完整的业务流程和业务场景。

平台化阶段-插件模式集成：

![](https://my-img.javaedge.com.cn/javaedge-blog/2024/05/6ba239b9e2e686dfd954bbdb9dc65d0b.png)

## 4 总结和思考

DDD是一种开放的思想体系，其核心在于通过领域模型的建立来引导整个设计过程：

- 本文认为战略设计的重要性可能要高于战术设计，因为它涵盖了对业务流程和核心概念的理解和组织
- 领域建模是一个动态的、迭代的过程，而非一成不变的瀑布式流程。这个过程类似于一个建模涡流，从战略设计到战术设计，不断迭代。在战术设计过程中，如果发现某些方面不合理，就需要对战略设计做出调整。同样，子域的划分和限界上下文的识别也是动态的，需要根据新的发现不断优化
- DDD不强迫采用特定的架构模式，它关注的是业务与技术复杂性是否得到了有效分离。无论是整洁架构、六边形架构还是传统的DDD分层架构，只要能够实现这一目标，它们都是可行的选择，即便是采用MVC分层架构，只要能够分离业务和技术复杂性，也同样适用

工程师思维模型，在领域驱动设计（DDD）的实施过程中也重要：

- 工程师需要培养用户思维、业务思维和产品思维，这有助于深入理解业务和问题域。基于这样的理解，工程师可以运用结构化思维来分解问题，并通过抽象思维提炼模型
- 结合分层、分治和工程思维，工程师可以有效地将设计转化为实际的代码实现

参考：

- https://cloud.tencent.com/developer/article/2082767