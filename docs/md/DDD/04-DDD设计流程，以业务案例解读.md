# 04-DDD设计流程，以业务案例解读

## 1 面向自动售货机的零售 Saas

### 1.1 业务背景

![](https://img-blog.csdnimg.cn/3d81c8fd93164ad5b18fb0aa39173e35.png)

### 1.2 团队背景

A公司：SaaS公司，主要面向零售企业客户
SmartRM产品团队：一位资深产品经理，几位产品策划
SmartRM研发团队：一位架构师，10+开发，资深开发3至4位

### 1.3 客户背景

B集团：零售行业某头部商家
全国各地有大量商超和便利店，有成熟的内部系统和供应链
基于自动售卖机的零售业务是新业务

### 1.4 案例优势

复杂度可覆盖DDD大部分知识点并体现价值
智慧零售市场庞大且场景接近日常生活
有数据分析需求，可结合大数据分析场景

### 1.5  整体数据流



![](https://img-blog.csdnimg.cn/8f47b8b3558849309f2ec9eda1ef8f72.png)

下面用三个实例去实现DDD设计流程

## 2 打车

主要分成两大部分：出行场景、生活服务场景

![](/Users/javaedge/Downloads/IDEAProjects/java-edge-master/assets//acf4727db7ef094fbb24ccf274f2ff9f.jpeg)

### 2.1 打车场景

这里我们选取打车场景（电商场景）去做业务角度的第一个的实践。

**（1）需求列表**

![img](https://img-blog.csdnimg.cn/img_convert/4cdb2c9c1be4f67671da7cfef74414ec.png)

首先我们先看一下需求列表，需求列表实际上是根据角色拆分为一系列的需求功能点，而公共点的序号表示一个用户在使用系统后的一个执行费，我们来串一下这些需求功能点。

在打车场景下乘客会去用户注册和登录，而如果想成为车主会去做车主认证，车主认证成功之后会做车辆的管理，平台则会定期去做营销投放，乘客会去抢券，当乘客有打车诉求，乘客会去发单，而平台根据当前的运力去做私生匹配，同时车主也可以主动接单。

当司乘匹配成功之后，他会去创建一个交易订单，同时会去针对订单去做投保。

同时会去将路径规划推送给车主，车主根据路径规划到达乘客的上车点，后面就是乘客上车，然后车主开车预约。

在这个过程中，如果涉及到危险，可以去做一键报警，而在整个流程中平台根据当前的交通状态计价，而车主也有权限去做改价（主要是高速费的场景）。到达下车点之后，乘客去支付。在订单完结之后，去做互相的评价，后面还会有一些其他的需求点，就不一一赘述了。

**（2）需求分析**

![img](https://img-blog.csdnimg.cn/img_convert/0dfdc6099a7c4976d630649c8c3e5a19.png)

需求分析阶段主要产出的一些指标：包括实体、值对象、命令和事件。

但在做需求分析之前，我们希望将业务场景去做细化，细化的好处是便于我们更好的去找到实体和值对象。细化业务场景的方式是有多种的，比如说第一种就根据产品的PRD可以做细化。

第二去做角色的补全，就拿第一个乘客评价的业务场景来举例，乘客评价我们是——基于什么去做评价、为什么去做评价。细化后，实际就上是乘客是基于整个订单的交付过程、对司机的车辆整洁状态、对司机的服务态度去做评价。

这里呈现的实体和指对象比较明确，包括乘客、订单和评价记录，对应的命令包括新增评价记录，查询用户详情以及查询订单详情。

而事件在当前的业务场景下其实是没办法完全确定的。比如说在后面做评分计算的业务场景里面，我们发现评分计算实际上是依赖整个评价的业务场景，在这个阶段我们再去做事件的记录。

**（3）领域梳理**

![img](https://img-blog.csdnimg.cn/img_convert/64da1e731b4e758ca3f3bcb9b41c106c.png)

在领域梳理这个阶段，我们要做4件事情，梳理实体和值对象、完善属性、能力和事件、构建依赖关系（实体和实体、实体和值对象等）、构建聚合。

我们拿乘客评价、更新评分的场景来举例。

![img](https://img-blog.csdnimg.cn/img_convert/ae304d825cc72c6831e7f2eccd01e490.png)

首先我们去设计评价的实体，在评价实体里面包括：评价ID、评价类型，在具体的流程里，会去对车辆的整洁程度，以及对司机的服务态度去做评价，所以设计评价类型；而评价主体是指谁来评价，评价媒介是根据什么来做评价，以及评价时间，它可能还会有其他的属性在这里就不一一列举。

能力实际上就是在评价设计里面，新提供新增评价的能力，而事件我们刚才其实已经处理好了，后面的评分计算其实是要根据新增评价之间的消息推动的，所以我们可以先分离出来评价的实体。

而刚才讲到评价的实体的媒介是承担了实体，而评价的主体是用户实体，所以我在图中实际上关联了评价实体、清单实体和用户实体的关联关系。

完成评价之后，我们会去计算评分，在计算评分的功能上，我们实际上是需要根据评分计算策略实体、评价实体来计算评分。

所以我们针对于评分的计算，划分出了一个领域服务。在第三个阶段我们需要更新评分，因为我们需要同时的去变更评价主体、评价实体、评价历史记录实体，所以我们将评分和评分的历史记录作为一个聚合，共同完成更新评分的动作。

**（4）确定上下文**

![img](https://img-blog.csdnimg.cn/img_convert/09196b925f07b70516e67dd7c140dbaa.png)

而在确定上下文这个阶段，我们需要自底向上的由实体和聚合，去划分上下文，再由上下文去划分更上层次的领域。

有两个方法大家可以借鉴：第一种就是**组合**，第二种就是**抽象。**

这两个实际上都是面向对象的概念，可以拿下图来确定一下，我们在上下文的划分和领域的划分里面，是如何去做抽象和组合的。在这个阶段我们实际上是要根据实际情况而定，如果就拿评分域来举例（左下角）：

![img](https://img-blog.csdnimg.cn/img_convert/d92bc90ab32522e979ecf81b2f5b9a50.png)

组合：如果业务逻辑比较复杂，我们可以将评分划分成两个上下文，第一个是评价上下文，第二个是评分上下文，这两个上下文是存在依赖关系的，这两个上下文组合之后，实际上可以组成一个较完整的评价体系，所以我们通过组合的方式是可以去组合一个更上层领域，所以我们组合成了评价域。

同理还有中间的打车交易，打车交易里面会有5个上下文，分别是形成匹配、交易、营销、活动、支付，这5个上下文共同组成了从顾客发单到交易完成了流程，所以我们通过这5个上下文组成了打车交易域。

抽象：可以参考右下角的司乘安全域，司乘安全域本身里面会有告警上下文和风控上下文，因为告警上下文和风控上下文没有明确的归属关系或者依赖关系，所以我们将它去做了更层次的抽象，把它抽象成司乘安全域。

而在标准的DDD设计到这里就结束了，后面的系统设计、数据模型设计，以及其他的详细设计、编码等，本身是不属于地基设计规范的，但我会在最后的交易阶段会去介绍。

## 3 电商场景

### 需求列表

![img](https://img-blog.csdnimg.cn/img_convert/744ffeaf70c233e71380fd1139d2254e.png)

首先看需求列表，针对需求列表去串需求，电商SAAS有商家的线索跟进，消费者会注册、商家会入驻，在商家入驻之后，商家会去设置店铺的营业时间、上架商品、库存、营销活动等。

在这个过程中，如果有一些使用层面不知道的地方，它可以和平台去做商家答疑。

针对于消费者视角，消费者可以去进店、选品、加购，打开订单确认页，选券、填写收货地址、下单，而消费者本身也可以取消订单，商家端也可以取消订单。

当消费者支付成功之后：

- 履约方式是核销，平台就需要生成核销码，而消费者可以做到店核销，商家核销完核销码之后，订单会是订单完成的状态
- 另一种履约方式是发货方式，商家可以构建这个商品去做发货，而消费者可以查看物流、确认收货，当所有的商品都收货之后，订单会去流转成订单完成状态

### 需求分析



![](https://img-blog.csdnimg.cn/img_convert/38d67b433b72b116d79f35f036761a8d.png)

下面看需求分析，我们只要拿商家发货场景举例。

首先我们根据PRD去细化业务场景，针对商家发货的业务场景，商家会先去进入到订单详情页，勾选要发货的订单的商品，选择物流公司、填写物流单号之后点击发货。

这里面实体和值对象包括商户、订单、子订单、履约单、履约子单、物流单和物流公司。

对应的命令包括查询订单信息、子订单信息；因为涉及到商家操作，所以要查询商户信息；因为我们需要勾选物流公司，所以我们需要查询物流公司列表，而典型发货的过程涉及到几个订单的创建：包括履约单、履约子单、物流单，真正的发货成功之后，会去更新订单信息和子订单信息。

而对应的事件，比如说后面的业务场景，会涉及到交易体系，会有商家发货的动作，会做APP内部的提醒或者短信的提醒，所以我们是需要订单开始履约之前消息的。

#### 为啥要履约单模型？

因为一个订单里面的多个子订单可能涉及分批发货，所以这个订单会对应多个履约单，而针对于一个履约流程，设计多段的物流配送，如第一阶段可能跨省配送，下一次让我们可以去做同城配送，做一个履约单会去对应多个物流单，就是履约单的一个场景。

### 领域梳理



![img](https://img-blog.csdnimg.cn/img_convert/2c6136cfa18d7e48e560d3773ea30c8c.png)

而回到这个领域梳理过程，在这个阶段我们需要查询订单和子订单信息，所以我们需要订单和子订单的聚合提供查询能力，我们需要物流公司实体去查询物流公司列表，我们点击发货的时候，我们去生成履约单，而履约单的多个商品是需要履约子单去承载的，所以生成履约单的时候，会去依赖履约单和履约子单的聚合，去完成创建履约单的业务功能，而物流单实体提供的是和物流公司的交互、进度、进度的变更以及通知能力，最后同时还依赖订单和子订单，更新订单状态以及子订单发货的能力，所以这里还是需要订单和子订单的聚合。

### 确定上下文



![img](https://img-blog.csdnimg.cn/img_convert/2c30306681ce1475a54583d84ce6bb8f.png)

我们在确定上下文这个阶段，我们一共拆分了11个领域，通过组合的方式去组装成了商户域，商户域是由商户上下文和店铺上下文组合而成的，同时还会有商品域、评价域、用户域、用户增长率和电商结算率等。

在这里需要提醒大家的是，如果我们已尝试组合或者抽象，但没有一个好的解决方案的时候，或者说我们没办法抽象和组合成为一个更高级别的领域的时候，我们可以考虑将上下文和领域按1:1去做设计，而上下文的划分本身也和当前的需求列表、实际情况去对应的。

当一个领域或者上下文业务复杂度较高、能力较多或者视角不同的时候，上下文的划分方式也是不一样的，如我们后面会讲的交易域的划分，及电商域的划分都是不一样的，但是我们划分方式就是一致的，都是通过组合和抽象的方式去做设计。

## 4 交易

打车场景和电商场景的交易

![img](https://img-blog.csdnimg.cn/img_convert/263728b5efe520a5212d92967d4ceba3.png)

打车场景里面：参与的双方是司机和乘客，约定是以订单作为约定；订单里面会去记录起止点、路线以及初估的订单金额；媒介是货币；而交易等价物实际上就是司机的驾车服务；我们将这个流程串联起来了，串联起来之后就是乘客通过货币购买司机的驾车服务，到达约定终点的过程。

电商场景里面：参与的双方包括买家和商家；约定是在订单里面，获取记录订单的金额以及发货方式；媒介还是货币，而交易的等价物是实物商品和虚拟商品。我们同样串联起来的结论就是，买家通过货币购买商家的实物和虚拟商品，通过发货和履约的方式完成价值交换的过程。

以上就是交易的概念。

### 需求列表

![img](https://img-blog.csdnimg.cn/img_convert/0453dd72d1d5b293787904e8cd414db9.png)

需求列表我在这里就不串联了，因为我在这里面列举实际上是电商场景的交易能力，前面在讲解电商需求列表的时候，我已经串联过了。

### 需求分析

![img](https://img-blog.csdnimg.cn/img_convert/2c162d32d34b6379a2d56bb2b6dcb9e5.png)

下面我们来看一下需求分析，我拿创建订单作为一个业务场景来讲解，在创建订单里面实际上细化的业务场景包括两个阶段：第一个阶段包括拆单，而系统根据拆单策略去组成拆单结果；第二个阶段就是根据拆单结果，去校验商品的上下架信息、用户是否被风控、店铺的营业状态，再锁定库存之后，创建清单。

而在这个阶段，我们沉淀的实体和值对象，包括拆单策略、拆单结果、用户店铺、商品库存、订单和子订单，而对应的命令其实也是比较多的，有查询拆单策略列表、生成多个查单结果、查询店铺详情、查询用户详情、查询商品详情、占用库存、创建订单、创建子订单。

而针对事件，比如说创建错误30分钟之后会自动取消订单，这种方式主要是针对于超时未付款的场景，而这种场景实际上依赖于订单创建成功事件消息。

### 领域梳理

![img](https://img-blog.csdnimg.cn/img_convert/689f80a9d9cee46692b8fab2c44c792e.png)

下面我们来看一下领域的梳理阶段，我们在这个阶段分成两个步骤，我来先来介绍一下订单和子订单，订单里面实际上记录的包括订单的唯一ID、买家信息、卖家信息、订单状态、订单金额，提供的能力实际上包括创建订单、订单实体，以及我们刚才梳理好的领域事件消息，而子订单实际上记录是子订单的ID、订单的ID、商品信息、优惠信息、数量等。

而在整个领域过程梳理阶段，我们第一阶段是要根据领域拆单策略，可以计算出拆单的结果是子对象列表，所以在上图的最左边，我把它定义成了一个领域服务。

在第二阶段，它在创建订单的过程，实际上要依赖库存实体、店铺实体、商品实体，而在创建时因为同时要创建定订单实体和子订单实体，所以订单和子订单实体形成了一个聚合。

### 确定上下文

![img](https://img-blog.csdnimg.cn/img_convert/0ced5fe0f8cd75496046fc4eda7d2ed2.png)

接下来看一下上下文和领域划分，那么通过抽象的方式，将购物车上下文抽象成了交易售前域；而我们将订单的发货核销这个能力，抽象成了正向的履约上下文。

同时我们在这个阶段做了组合，我们将正向的履约上下文、逆向的履约上下文以及电子凭证上下文，共同组成了交易的售后域，而且我们将交易的售前、售中、售后共同组成的交易域，这个实际上就是我们确定上下文的一个过程。