# 对象存储

> 数据库的历史上，每次存储介质变化都会引发软件变革。从 SAN 存储到 SSD 到大内存到 NVM，都触发了数据库内核从理论到工程的演进。

数据库一直是推动企业数字化和创新的最重要基础设施之一。从关系型数据库到 NoSQL、分析型数据库、多模数据库，涌现新型数据库产品，满足不同企业的应用场景和细分市场需求。

但关系型数据库（Relational Database Service，RDS）依然占据数据库市场大半壁江山，根据 IDC 近期发布的《2023 年上半年中国关系型数据库软件市场跟踪报告》，2023 年上半年中国关系型数据库软件市场规模为 17.5 亿美元，其公有云关系型数据库的市场份额约为 59%。而根据 Garnter 《Forecast Analysis: Database ManagementSystems, Worldwide》报告中的预测，2023 年全球关系型数据库总市场达到 838 亿美元，在数据库总盘里公有云部分占比也约为 59%。

RDS 通常以云盘（即块存储）作为其核心存储基础设施。如 AWS 的 RDS 服务所有实例规格均采用 Elastic Block Store（EBS）云盘。

对使用 RDS 的用户及在公共云上购买虚拟机来自建数据库服务的用户，云盘是否代表存储的最终选项？ No！在技术革新缺席的前提下，云盘在性价比和计费策略方面失去了其竞争优势，我们判断其会从云厂商的主导产品降级为边缘选项。

公共云的RDS将会从依赖云盘向利用好对象存储，向采用更云原生架构的新时代。为适应对象存储，充分发挥其优势，数据库架构势必大改，水平扩缩容、容灾技术及存储引擎的数据格式都随之变化。

## 1 云盘的问题

### 1.1 定价比较高

如一块 1TB 标准型云盘（含 5 万 IOPS 及 350MB 带宽），云服务商收取约 1000 元每月基础费。为服务海量客户，云盘 IOPS（输入/输出操作每秒）和带宽通常会在软件通过流控限制，免费 IOPS 额度通常在 1000~3000，而带宽限额约150MB/s。超出限额，用户需向云厂商购买额外 IOPS 和带宽，若将 IOPS 提高至 10 万（这一性能水平对于企业级 NVMe SSD 来说并不算特别高），用户需要额外支付 1500 元每月的预配置性能费用。然而，1TB 的企业级 NVMe SSD 的一次性购买成本还不到千元

### 1.2 云盘的弹性尚未完全向用户开放

主流云厂商的云盘仅支持扩容，不支持缩容。该限制导致业务在缩容时须曲线救国，即逻辑复制，先将数据迁移到一块容量更小的新云盘，然后才能释放原较大云盘。

部分云厂商如 AWS 的 EBS 对控制面还存在限流，限制两次扩容操作之间间隔6h。这虽保证服务稳定性，但也限制用户对存储资源的即时调整能力。这都限制了上层软件基于云盘实现按存储使用量付费的能力。

### 1.3 灾难恢复能力局限于单个可用区（AZ）

云厂商建议的最佳实践：为实现更高级别业务连续性，客户应采取跨可用区的灾难恢复策略。这意味着，如客户想为他们的数据库实现跨 AZ 的灾难恢复，他们不得不购买多个云盘。

但这种额外投资并非最经济，因云盘定价已包含单 AZ 多副本数据的分摊成本。当用户为实现跨 AZ 的冗余而购买更多云盘时，存储层面的多副本与数据库层面的多副本机制叠加，便产生资源的重复配置。

### 1.4 系统性能瓶颈

面对高性能数据库需求，云盘性能也成为限制整体系统性能的**薄弱环节**。云盘使用分布式架构，通过 Erasure coding 机制将数据分割成多个小片段，并将其冗余存储在多个服务器。进一步，还可对数据进行压缩。这些技术以牺牲一定性能为代价，换来显著可扩展性和成本效益。由于所有 I/O 操作都要跨越网络，因此云盘延迟通常比本地盘高一个数量级。



旗舰数据库产品如 Aurora 和 PolarDB 采纳更新设计理念，构建定制化的分布式存储集群，来解决云盘性能：

- Aurora采用日志即数据库的理念，减少数据库节点与存储节点之间的数据传输量
- PolarDB 使用 RDMA 和 NVM 优化 I/O 延迟，

二者都支持多个数据库节点并发访问存储节点的共享数据架构。但这些存储系统与数据库之间的通信是通过私有接口。而且这些专用存储的定价比云盘更高。

## 2 其他云存储选项

相比云盘，云上的本地盘实例存储性价比要高很多。实例存储采用类似 SR-IOV 和 SPDK 的高效虚拟化技术。因此实例存储的延迟和带宽都接近物理 SSD 性能。实例存储的价格也经济很多，折算下来 1TB 实例存储月单价 300 以下。

但实例存储在数据持久性方面有局限。由于设计为单副本存储，若宿主机故障，存储其中的数据可能永久丢失。此外，当虚拟机迁移至另一台宿主机，实例存储数据也会被清除。因此，实例存储不适合在需要高可靠性和数据持久性的应用场景中作为主要存储介质。

对象存储的价格最低，1TB 一个月存储成本约120。低定价得益其软硬件协同优化：

- 软件层采用更激进 EC 和压缩算法来提高存储密度
- 硬件使用高密度盘和专用服务器，降低服务器、机架及电力的均摊成本
- 对象存储系统还利用定制的 FPGA 硬件来减轻 CPU 处理网络和数据的压力。在资源调度上，对象存储一般会采用大集群的部署方案，这有利于降低碎片率，提高系统的整体水位线。得益于其分布式大资源池的设计，对象存储能够支持 10Gb 乃至 100Gb 的访问带宽。此外，对象存储通常还具备跨可用区域（AZ）的灾难恢复能力。

对象存储的缺陷是延迟较高，首字节访问延迟可能高达数十ms。部分源于早期对象存储解决方案通常使用 HDD 作存储媒介，且在软件层面，I/O 请求排队处理也会造成一定延迟。但高延迟并非对象存储本质缺陷，而是由成本考虑和产品定位所做的权衡。



其实在技术层，构建低延迟对象存储系统完全可行。如AWS的"S3 Express One Zone"服务，将延迟减少至原十分之一，实现ms级响应，接近传统文件存储 NAS 系统水平。

S3高延迟是产品定位和技术的权衡，有得必有失，"S3 Express One Zone"不再支持跨 AZ 容灾，所有数据都在单 AZ 内，数据持久性下降。

"S3 Express One Zone"更强，也更贵，价格不仅是 S3 标准版 7 倍，也超过自家云盘，达到 EBS gp3 的 2 倍。

## 3 解法：持久性与延迟的解耦

云存储产品各自特点和不足：

![](https://javaedge.oss-cn-shanghai.aliyuncs.com/14c4b4569e94e398a0b8df3fd326b9cd.jpeg)

当前市场上尚未出现一种云存储产品，可以同时在低成本、低延迟、高持久性几个维度上都达到令人满意的程度。

随云计算普及，降本逐渐成为用户首要诉求，一些公司如 37signals 和 X，已经基于成本效益的考量决定下云，从公共云平台转回到传统的 IT 基础设施。在这种趋势下，云数据库服务供应商面临的紧迫挑战是如何在现有的存储 IaaS 产品基础上，构建更有成本竞争力的数据库服务。

## 4 两个方案

### 4.1 基于实例存储搭建多副本的数据库系统

实例存储是单副本存储，存在风险：一旦其宿主机故障或相应虚拟机迁移，就可能数据丢失。这一方案的理论基础建立在一个假设：多个实例存储丢失数据的概率是相互独立的。基此，增加副本数量，会降低多个实例存储同时丢失数据的概率。

然而，这个假设并不总成立，现实因为工程限制，多个实例存储可能因共同原因导致同时数据丢失。如可能所有存储都使用同一批存在固件缺陷SSD，导致多台主机同时下线；或云厂商控制系统故障，引起大规模虚拟机迁移。因此，对于那些对数据持久性有极高要求的生产环境来说，这种方案不适用。

###  4.2 将存储的持久性和延迟两个特性进行分离

通过：

- 对象存储实现高持久性

- 实例存储/云盘来实现低延迟

尽管对象存储可提供低成本、高带宽和跨可用区的数据持久性，但作为关系型数据库主存储时，其读写延迟成为显著挑战。为此，采用一种分层存储策略，将存储解耦为三个组件分而治之：

- 持久化

  对象存储仅负责数据持久化，保证系统容灾

- 写缓存

  写操作可通过缓存层降低写延迟，技术上可用 Raft 这类同步协议，缓存到低延迟的存储介质，如本地磁盘或云盘，甚至可考虑追加写入到MQ服务。

- 读缓存

  读操作也是，通过缓存层降低读延迟，可能是基于本地磁盘、NAS，或者是专为降低延迟而优化的对象存储加速器，将负责实现快速的数据加载。

SIGMOD 发表的"LogStore: A Cloud-Native and Multi-Tenant Log Database"论文中就使用这方案。LogStore 是内部使用云原生日志数据库，底层采用对象存储，为降低写入延迟，写入的日志先通过 raft 协议刷到 3 副本的本地 SSD 中即提交，再由 Leader 节点将数据写入到对象存储。硅谷初创公司 Neon 也采用这方案。Neon 宣称是开源版的 Aurora Postgresql，采用算存分离架构对开源的 PostgreSQL 改造。其存储层由 Safekeeper 和 PageServer 两个组件构成。Safekeeper 负责持久化和复制 WAL 记录，使用 Paxos 协议实现分布式一致性，将 WAL 记录保存在 EBS，并将提交的 WAL 记录传递给 PageServer。 PageServer 负责将 WAL 记录应用到 Page 上，生成 Page 的快照，并将 Page 存储在对象存储中，缓存 Page 在实例存储上，以提高读取性能。Neon实现中，数据库主存储是对象存储，写缓存EBS，读缓存是实例存储。

## 5 新商业模式契合对象存储

公共云数据库服务正倾向提供 Serverless 运行模式，以迎合现代开发者的弹性需求。18年AWS 就推出Aurora Serverless，22 年，AWS 又推出了 Aurora Serverless V2。在今年的 AWS Reinvent 大会上，AWS 一口气发布了三款 Serverless 数据库产品：Aurora Limitless Database、ElastiCache Serverless 和 Redshift Serverless，摆出全系 Serverless 化气势。Serverless数据库深受青睐是因为：

- 低门槛使用成本
- 其能在面临突如其来的机会时提供快速且灵活的扩展能力

因此，Serverless 数据库成为初创和那些流量增长高度不可预测的创新产品的选择。

本质上Serverless数据库采用”按实际使用付费(pay as you go)“新商业模式。Serverless数据库模式下，云的 dbPaaS 软件会实时追踪用户活动，从而精确计算其资源使用情况。无论是执行 SQL 命令所耗CPU时间，还是读写操作产生IO次数，亦或是数据存储的总量，所有这些都被量化为资源单位（如计算单元 CU、请求单元 RU），并据此计费。技术如何支撑这种新的商业模式，比如数据库如何根据工作负载的变化智能的扩缩容取决于 dbPaaS 和内核的实现。

业界实现Serverless架构常见方法之一是通过给基于算存分离架构增加自动伸缩（Auto-Scale）功能。因此云原生数据库如Aurora、PolarDB都能较快推出其Serverless版本。在这样架构下，存储层通常设计为多租户模式，以实现资源共享和成本效率；而计算层则通常是单租户，确保性能和隔离性。随数据库负载增加，这种模式允许计算节点通过弹性扩容迅速提升处理能力。相对地，当负载减少，计算节点可弹性缩容，甚至完全停止，以优化资源使用并减少成本。

CockroachDB也采纳这种Serverless架构。为适应这种模式，对底层KV存储层重构，转变为支持多租户架构，且SQL节点和KV节点不再运行在同一台服务，走向算存分离。

可见，存储池化是Serverless数据库架构核心设计原则。只有存储池化，才能做到按存储的使用量计费。Aurora、PolarDB 实现这一机制的策略是构建他们自己的分布式存储集群。但这种做法要求云厂商在产品推出前进行大规模一次性投资，并在产品初期推广阶段承受由于存储使用未达预期而产生的潜在亏损。但对那些希望利用开源软件自行搭建 Serverless 数据库服务的大型企业用户及提供 Serverless 数据库服务的小型的第三方数据库厂商，却存在陷阱。若构建 Serverless 服务前需首先投资搭建一个存储池，他们就陷入传统模式——即预购硬件并在其基础上构建数据库服务，这种做法与Serverless理念相悖。最理想的技术方案是做到不囤货，实际使用多少存储，就向云厂商付多少存储费用。

此外，Serverless 数据库的设计理念自然包含Region级容灾功能，这是其另一项核心能力。用户选择Serverless服务，即他们已不再关注运行数据库的具体服务器或所在可用区（AZ）。这种服务模式下，用户不愿意去单独从三个不同 AZ 购买一套 Serverless 数据库，再手动设置数据同步——这与 Serverless 易用性相悖。因此，Serverless 数据库须确保其计算节点池和存储池都在跨 AZ 环境中提供无缝容灾。

存储池化、按使用量计费及 AZ 级容灾，Serverless数据库对存储的需求正是对象存储产品的关键特性。而传统云数据库使用云盘在成本、弹性能力、容灾能力均弱于对象存储产品。基此，我们预见在按使用量计费这种新的公共云商业模式被广泛接受后，未来Serverless数据库都会将对象存储做首选。

## 6 下一站：以对象存储为中心的新架构

随数据库存储基础设施向对象存储的逐步迁移，可预见新架构变化：

### 6.1 行列混合存储格式

数据库存储引擎的数据格式将从纯行存向行列混合格式变化。B+树存储引擎可采用调高数据页大小，并采用页内列式存储的技术来实现。而基于 LSM 的存储引擎在这块具有更大优势。将行存数据转换为 Pax 格式（行列混合存储格式）存入对象存储的好处：

#### ① 显著降低存储成本并减少数据加载时间

如以行列混合存储格式进行数据转换，可将1TB数据压缩到仅为原始体积的 20%至 40%存储在对象存储中。借助 25Gb 的内网带宽，加载并预热这些压缩数据到缓存的过程大约只需100s

#### ② 减少数据库内存缓存的消耗

采用 Pax 格式还能减少数据库内存缓存的消耗，如原计算节点需32G内存，现只需12G就能达到同样性能，进一步降低计算节点成本

#### ③ 实现混合事务/分析处理（HTAP）

数据库引擎可借助 Pax 格式实现混合事务/分析处理（HTAP），Google 的 Spanner 数据库就是一个例证，它采用了基于 Pax 的 Ressi 存储格式，支持 HTAP 操作

### 6.2 OLTP与数据湖的深度融合

传统上，将OLTP数据迁移到OLAP系统的常规方法依赖ETL。然而，ETL不仅管理负担重，而且增加一个易错环节。鉴于这些挑战，近年业界出现向"NoETL"解决方案转变，将 ETL 过程内置在数据库，以提高用户进行数据管理和分析的易用性。如AWS推出从Aurora服务直接到 Redshift 数据仓库的 NoETL 集成。

而OLTP数据库内核中，原生支持将全量数据以行列混合存储格式持久化并写入对象存储，会更近一步，促进 OLTP 数据库与现代数据湖技术的协同工作。利用Iceberg、Hudi 和 Delta Lake，OLTP数据库可无缝将在线数据直接写入数据湖，帮助企业更简单、实时管理和分析其数据资产。

### 6.3 使用 K8s 管理数据库变得普及

管理有状态服务一直充满挑战。随KubeBlocks及各种数据库 Operator 等开源数据库控制面管理软件的发展，有越来越多工具支持在 K8s 对数据库进行高效管理。

当数据库持久性通过 K8s 外部的对象存储保证时，对 K8s 中的数据库 Pod 进行高可用切换、节点迁移、数据迁移、备份等各种管理任务的复杂性会减轻，执行效率更高。两个方向发展相辅相成，会推动在 K8s 管理数据库的普及。

公共云中的关系型数据库正处转型临界点：从依赖云盘转向利用对象存储。

- 过去RDS模式是云托管，客户要预选硬件配置（云服务器、云盘、VPC 和负载均衡器），然后在这些硬件上部署数据库内核
- 而对象存储时代，没有预置 IaaS 的限制，数据库内核进一步云原生化更有弹性更加强大，这会是数据库领域近期最大的技术变革
