

# 10-Java 系统架构安全面试实战

## Java 系统架构安全面试实战

这一个模块讲一下在我们研发的系统中，可能会碰到哪些安全问题，黑客会以什么样的方式来对网站进行攻击

**为什么我们作为一个 Java 开发人员，还要去了解安全相关的问题呢？**

目前大多数技术人员对于项目安全方面的关注度并不是很高，之前在某几个互联网大厂中都发生过一些删库跑路的问题，影响系统的安全性和数据的安全性，并且如果以后作为一个负责人去带领开发一个项目，项目的安全性是很重要的，因此系统的安全在系统架构中处于一个非常重要的地位，如何去避免被黑客攻击导致系统故障以及避免系统的核心数据遭到泄露是非常重要的一个事情，我们作为开发人员，是一定要去了解常见的一些攻击手段，如果一无所知的话，就证明了我们的能力不够全面，可能就会导致面试结果不理想

我们作为开发人员，对安全方面的掌握程度达到 `了解程度` 就行，在系统中我们做一些简单的防御措施，之后将专业的安全防护问题交给专业的公司去做就可以了！



### XSS 网络攻击

先说一下 XSS（Cross-Site Scripting，跨站脚本攻击）网络攻击，这是一种常见的网络安全漏洞，它允许攻击者将恶意脚本注入到受害者访问的网页中

**XSS 攻击的原理就是：**

1. 注入恶意脚本：攻击者将恶意脚本代码（html+javascript）嵌入到被攻击网站的前端代码中
2. 受害者访问：当受害者访问到被攻击的网站时，这个网站会执行恶意的脚本，由于你认为这些脚本是可靠的，会允许执行
3. 窃取用户数据：当恶意脚本被执行后，可能就会窃取用户的个人信息、篡改网页信息或者引导你到攻击者自己的网站中

![1705739144202](https://11laile-note-img.oss-cn-beijing.aliyuncs.com/1705739144202.png)

**XSS 攻击分为两种：`反射型攻击` 和 `存储型攻击`：**

- **反射型攻击**：这种类型的攻击通常通过URL参数传播。攻击者会想办法让你点击一个 URL 链接，这个 URL 链接指向的攻击者自己服务器上的一段恶意脚本，当你点击之后，恶意脚本就会被返回到浏览器中执行，之后就会控制你的浏览器中的行为了，这时恶意脚本有了你的 cookie 信息，会以你的个人身犯去去关注某个人或者发布一些内容等等（可以做任何事情）
- **存储型攻击**：这种类型的攻击将恶意脚本存储在服务器上，通常是在数据库中。比如攻击者在网站中发布一条评论，其中包含了恶意脚本（js 脚本），那么当你去浏览攻击者发布的这一条评论后，会导致恶意脚本运行，控制你浏览器中的一切行为



**XSS 攻击防护手段：**

- 消毒机制：在将用户输入的数据输出到HTML页面之前，对其进行编码，以防止脚本执行。例如，将`<`编码为`&lt;`，`>`编码为`&gt;`，`"`编码为`&quot;`，`'`编码为`&#039;`等，将恶意脚本的 `<html>、<script>` 编码之后，就不会在浏览器中被执行了
- HttpOnly 方式：HttpOnly 用于设置 Cookie 的属性，表示浏览器只允许通过 HTTP 协议发送 Cookie，而不允许通过客户端脚本（如 JavaScript）访问，那么就算恶意脚本执行了，但是他们也无法读取和修改这些 Cookie，可以保护用户信息



### SQL 注入攻击

SQL 注入攻击是攻击者在应用程序的数据库查询中插入恶意SQL代码，导致数据被恶意修改或丢失等问题



**这里举个例子：**

假设有一个登录表单，用户输入用户名和密码，然后服务器端的代码将这些信息用于数据库查询，以验证用户身份。如果这个查询没有正确处理用户输入，攻击者就可以利用SQL注入。

假设原始的SQL查询是这样的：

```sql
SELECT * FROM users WHERE username = '输入的用户名' AND password = '输入的密码';
```

在没有防护的情况下，如果攻击者在用户名字段输入 `' OR 1=1 --`，那么SQL查询将变成（其中 `--` 在 SQL 中是注释，后边的 SQL 语句就失效了）：

```sql
SELECT * FROM users WHERE username = '' OR 1=1 --' AND password = '输入的密码';
```

由于 `OR 1=1` 始终为真，所以这个查询会返回所有用户的记录，而 `--` 用于注释掉后面的 `AND password` 部分，这样攻击者就可以绕过密码验证。



**SQL 注入防护措施：**

- `保护数据库表结构`：不要让别人知道数据库的表结构，不要将一些异常的 SQL 信息给回显到浏览器中，否则就会通过 SQL 语句被推测出来表结构，之后进行 SQL 注入攻击
- `SQL 预编译`：MyBatis 中也有防止 SQL 注入的措施，MyBatis 会将 `#{}` 的参数作为预编译语句的一部分进行处理，会对参数进行转义处理，那么传入进来的 SQL 语句就会被当作是参数，而不会作为 SQL 执行了，以此来防止 SQL 注入

```xml
<select id="selectUserById" resultType="User">
    SELECT * FROM users WHERE id = #{id}
</select>
```



### CSRF 攻击

CSRF（Cross-Site Request Forgery，跨站请求伪造）是一种网络攻击，攻击者利用用户的登录状态发起未经授权的请求，用于查询用户数据、发起交易等等

攻击者可以利用 XSS 跨站点脚本攻击，获取用户 Cookie，再利用 Postman 发送跨站点伪造请求



**CSRF 攻击防护措施：**

- `防止 Cookie 被窃取`：将网站的 Cookie 设置 HttpOnly 属性，禁止被恶意的 js 脚本窃取 Cookie 信息
- `随机 Token`：每次返回一个页面给用户时，都生成一个随机 token 附加在页面的隐藏元素中，同时在 Redis 中再存储一份，当发送请求时，附加上随机 Token，验证通过才可以发送请求，这样如果伪造请求，不知道随机 Token 是什么，也就无法伪造了
- `验证码`：页面提交时，使用图形滑动验证码认证，可以避免伪造请求
- `Referer 请求头`：Http 请求里有一个 Referer 请求头，带有这个请求的来源，服务端可以验证一下这个请求是不是从自己的页面里来的，如果是的话才执行，否则就拒绝执行





### 用户上传文件，可能会遭到什么样的黑客攻击

如果我们的网站 `允许别人上传文件`，那么文件可能是可执行的脚本，可能是病毒文件，其实这个是非常危险的，如果是脚本的话，可能会在服务器执行，搞很多破坏，比如黑客黑掉你的服务器，进行勒索之类的

比如攻击者将自己的文件后缀改为 .jpg、.txt 之后进行上传，但是这个文件其实是病毒文件，通过病毒文件可以连接数据库等等，做许多危害系统的操作



**上传文件攻击的防护措施**

- `限制上传文件类型`：只能上传指定的文件类型，并且限制文件的大小，还要对文件重命名，不能仅仅靠后缀来判断文件类型，还要通过文件二进制数据开头的 `magic number（魔数，用于标识文件类型）` 来判断文件类型

  比如 JPEG 的魔数为：`FFD8FF`，PNG 文件的魔数为：`89504E47`

- `压缩上传文件`：压缩后，可以破坏原来的文件结构，避免文件在服务器执行



### DDoS 攻击

DDoS（Distributed Denial of Service，分布式拒绝服务攻击）是一种网络攻击手段，其目的是通过大量的流量或请求来使目标服务器或网络资源不堪重负，从而导致正常用户无法访问这些资源

简单来说，就是给你的服务器发送大量的请求，导致你的服务器线程资源、网络资源、CPU 资源等等全部被占满，导致其他用户无法正常使用

Dos 攻击是一对一的，攻击者通过一台高性能服务器来拼命地给你的网站发送请求，这个很好解决，通过限制 IP 即可

DDoS 是攻击者控制大量的机器，这些机器都被植入木马给控制了，也就是所谓的 `肉鸡`，使用大量肉鸡给你的网站发送大量请求，导致网站的服务器瘫痪

**DDoS 攻击的防护**

个人很难防护，一般都是购买云厂商的安全服务来解决



**DDoS 攻击的方式：**

- `基于 SYN Flood 的 DDoS 攻击`

主要利用了 TCP 三次握手的特性来攻击，TCP 三次握手流程是（[TCP 三次握手详细参考](https://blog.csdn.net/qq_45260619/article/details/134274099)）：

1、客户端发送 SYN 请求建立连接

2、服务器收到 SYN 后，返回客户端 SYN+ACK 表示请求接收，等待客户端再次返回 ACK

3、客户端收到服务端发回的 SYN+ACK，返回一个 ACK 给服务端，连接被成功建立

服务端在返回 SYN+ACK 给客户端之后，会给该客户端预留一部分资源，等待与客户端建立连接，那么攻击者就会通过大量机器去和服务端建立连接，但是并不给服务端发送第三次的 ACK，导致服务端建立了大量的半连接在等待列表中，最终资源耗尽

![1705744668300](https://11laile-note-img.oss-cn-beijing.aliyuncs.com/1705744668300.png)

- `基于 DNS Query Flood 的 DDoS 攻击`

这种方式利用DNS（域名系统）服务的特性来消耗目标服务器的资源。这种攻击的基本原理是向目标 DNS 服务器发送大量的 DNS 查询请求，从而占用其带宽和处理能力，导致正常用户无法获得 DNS 解析服务



- `基于 HTTP Flood 的 DDoS 攻击`

这种方式专门针对 Web 服务器的 HTTP 服务。攻击者通过发送大量的 HTTP 请求来消耗服务器的资源，导致正常用户无法访问网站

攻击者通过控制大量肉鸡去给服务器发送大量 HTTP 请求，Web 服务器消耗大量资源对大量 HTTP 请求解析，最终导致 Web 服务器 CPU 过载、内存耗尽、网络带宽打满等情况而瘫痪

比如对于 Nginx 、Tomcat 这两个 Web 服务器来说，都是一个进程启动多个线程来并发处理 HTTP 请求，当 HTTP 请求数量很大，就会导致 Web 服务器瘫痪



