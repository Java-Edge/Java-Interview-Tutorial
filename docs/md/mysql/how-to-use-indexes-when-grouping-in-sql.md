# SQL执行Grouping by时如何才能使用索引？

group by是否能用索引？有时需要group by把数据分组，再用count、sum等聚合函数做聚合统计。

假设有 SQL：

```sql
select count(*) from table group by xx
```

看起来必须把所有数据放到一个临时磁盘文件里还有加上部分内存，去搞一个分组，按指定字段值分组，接着对每组执行一个聚合函数，这性能也是极差，涉及大量磁盘交互。

因为索引树默认按指定的一些字段都排序好的，字段值相同的数据都在一起，若走索引去执行分组后再聚合，性能就比临时磁盘文件好多了。

所以一般对group by后的字段，最好也按联合索引最左侧字段开始，按序排列，就能完美利用索引直接提取一组组数据，然后针对每组数据，执行聚合函数。

group by和order by利用索引原理和条件差不多，本质都是在group by和order by之后的字段顺序和联合索引中的从最左侧开始字段顺序一致，然后就能利用索引树，快速根据排序好的数据执行后续操作。

就无需针对杂乱数据利用临时磁盘文件+部分内存数据结构，进行耗时耗力的现场排序和分组，真是速度慢，性能差。

## 平时设计表里的索引

必须充分考虑后续SQL要咋写：

- 会根据啥字段进行where语句里筛选和过滤？
- 根据哪些字段进行排序和分组？

考虑好后，就能为表设计两三个常用索引，覆盖常见的where筛选、order by排序和group by分组的需求，保证常见SQL语句都能用上索引。只要所有查询语句都可利用索引执行，速度和性能通常都不会太慢。如查询还是有问题，就要基于执行计划进行深度SQL调优。

然后对更新语句，最核心问题：

- 索引别太多，否则更新时维护太多索引树
- 可能涉及锁等待和死锁
- 可能涉及MySQL连接池、写redo log文件等