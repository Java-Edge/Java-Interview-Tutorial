> 全是干货的技术号：
> 本文已收录在github，欢迎 star/fork：
> https://github.com/Wasabi1234/Java-Interview-Tutorial

# 二进制安全

二进制安全是一种主要用于字符串操作函数相关的计算机编程术语。一个二进制安全函数，其本质是将操作输入作为原始的、无任何特殊字符意义的数据流。其在操作上应包含一个字符所能有的256种可能的值（假设为8比特字符）

- 那什么是特殊字符？
标记字符，如转义码，\0结尾的字符串（如C语言中的字符串），不是二进制安全的。

- 场景
在处理未知格式的数据，例如随意的文件、加密数据及类似情况时，二进制安全功能是必须的。函数必须知道数据长度，以便函数操作整体数据。



# Redis二进制安全原理
```c
struct sdshdr{
        int len;//buf数组中已经使用的字节的数量，也就是SDS字符串长度
        int  free;//buf数组中未使用的字节的数量
        char buf[];//字节数组，字符串就保存在这里面
};
```
redis通过定义上述结构体的方式，扩展了C语言底层字符串的缺点，字符串长度的获取时间复杂度从原来的O（N）变成了O（1），另一方面也可以通过free的动态改变来减少内存的分配。需要强调一点的是buf数组不是存储的字符，而是二进制数组，因为C语言字符串中间是不能出现空字符的，而二进制数据中间很有可能会有空字符，所以C语言是二进制不安全的，而redis又是二进制安全。为了存储多种类型的数据，redis就直接把所有数据当作二进制来存储，这样就可以存储媒体文件和字符串，所以SDS虽然叫简单动态字符串，但是它可不只是用来保存字符串。SDS在Redis中是实现字符串对象的工具。当你对该字符串取值时是通过len属性判断实际内容的长度，然后取的值。拼接字符串时是追加到free空间中的。

**简单总结：** 二进制安全的意思就是，只关心二进制化的字符串，不关心具体格式，只会严格的按照二进制的数据存取，不会妄图以某种特殊格式解析数据。

Redis的简单动态字符串SDS对比C语言的字符串char*，有以下特性：
- 可以在O(1)的时间复杂度得到字符串的长度
- 可以高效的执行append追加字符串操作

SDS通过判断当前字符串空余的长度与需要追加的字符串长度，如果空余长度大于等于需要追加的字符串长度，那么直接追加即可，这样就减少了重新分配内存操作；否则，先用sdsMakeRoomFor函数对SDS进行扩展，按照一定的机制来决定扩展的内存大小，然后再执行追加操作，扩展后多余的空间不释放，方便下次再次追加字符串，这样做的代价就是浪费了一些内存，但是在Redis字符串追加操作很频繁的情况下，这种机制能很高效的完成追加字符串的操作。


![](https://img-blog.csdnimg.cn/20200825235213822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_SmF2YUVkZ2U=,size_1,color_FFFFFF,t_70#pic_center)